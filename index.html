<!doctype html>   
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Taiwan Pride ğŸŒˆï½œReservation Paymentï½œ10/24 é€±äº”æ™šé¤åå–®</title>
<style>
:root{
  /* S2 é¢¨æ ¼è‰²ç›¤ */
  --bg:#0A0B0F; --card:#10131A; --muted:#9AA4AF; --fg:#F2F5F8; --border:#1f2430;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  --rainbow: linear-gradient(90deg,#ff5f6d,#ffc371,#9be15d,#00e3ae,#45aaf2,#9b59b6);
  --btn-grad: linear-gradient(90deg,#7dd3fc,#86efac);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",ui-sans-serif,system-ui;
  background: radial-gradient(800px 600px at 10% -10%, rgba(255,255,255,.06), transparent), var(--bg);
  color:var(--fg);
}
a{color:inherit;text-decoration:none}
.wrap{max-width:980px;margin:28px auto 64px;padding:0 14px}

/* æ¨™é¡Œä¸‰è¡Œï¼ˆç™½å­—ï¼‹å…‰æšˆï¼‰ */
.tl .t1,.tl .t2,.tl .t3{color:#fff;text-shadow:0 0 8px rgba(255,255,255,.28),0 0 18px rgba(255,255,255,.12)}
.tl .t1{font-size:28px;font-weight:900;line-height:1.15}
.tl .t2{font-size:22px;font-weight:800;opacity:.95}
.tl .t3{font-size:16px;font-weight:700;opacity:.9}
.rainbow-line{height:2px;background:var(--rainbow);opacity:.6;border-radius:2px;margin:6px 0 14px}

/* æœå°‹/æ§åˆ¶å€å¡Š */
.card{
  position:relative;border-radius:16px;padding:14px;border:1px solid rgba(255,255,255,.06);
  background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
  box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
  margin-bottom:12px;
}
.row{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;align-items:end}
label{font-size:12px;color:var(--muted);margin-bottom:4px;display:block}
.input-wrap{display:flex;flex-direction:column;min-width:0}
input,button,select{
  width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--border);
  background:#0f1117;color:#0fffd1; /* éµå¾ªèˆŠç‰ˆé€£çµæŒ‰éˆ•å­—è‰² */
  outline:none;font-size:14px
}
input{ color:var(--fg); }
input::placeholder{color:#6b7280}
button.primary{background:var(--btn-grad);border:0;color:#0b0c10;font-weight:900;letter-spacing:.2px}
button.primary:hover{filter:saturate(1.08);}

/* çµ±è¨ˆåˆ—ï¼ˆé é¢ä¸Šæ–¹ï¼Œä¿ç•™ä¸­è‹±ï¼‰ */
.stats{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 6px}
.chip{display:flex;align-items:center;gap:8px;background:#0f1117;border:1px solid #2b3244;border-radius:999px;padding:6px 10px;cursor:pointer}
.chip .dot{width:8px;height:8px;border-radius:50%}
.chip.total .dot{background:#a3e635}
.chip.paid .dot{background:#22c55e}
.chip.unpaid .dot{background:#ef4444}
/* NOTE chip */
.chip.note .dot{background:#60a5fa}
.chip .lab{font-size:12px;color:var(--muted)}
.chip .num{font-size:13px;color:#fff;min-width:16px;text-align:right}

/* çµæœåˆ—è¡¨ */
.grid{display:flex;flex-direction:column;gap:8px}
.person{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;display:grid;gap:8px;cursor:pointer}
.line{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.left,.right{display:flex;gap:10px;align-items:center;min-width:0}
.namebar{display:flex;align-items:center;gap:8px;min-width:0}
.flag{font-size:18px}
.personN{font-weight:900;font-size:15px;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ig{font-size:13px;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; text-transform:uppercase; } /* IG é¡¯ç¤ºå¤§å¯« */
.country{opacity:.6}

/* é‡‘è‰²æ¼¸å±¤ï¼ˆæ²¿ç”¨èˆŠæ¨£å¼ï¼‰ */
.goldtext{
  background: linear-gradient(180deg,#EAD28A 0%,#D9B550 35%,#B98A32 70%,#7A6027 100%);
  -webkit-background-clip: text; background-clip: text; color: transparent; font-weight:900;
}

/* pay_status å¾½ç«  */
.pay{display:inline-flex;align-items:center;gap:8px}
.badge{position:relative;width:22px;height:22px;display:grid;place-items:center;filter:drop-shadow(0 1px 2px rgba(0,0,0,.45))}
.badge svg{width:22px;height:22px;display:block}
.badge .ring{fill:#0f1117;stroke-width:2.6}
.badge .glyph{stroke:#fff;stroke-width:1.9;stroke-linecap:round;stroke-linejoin:round;fill:none}
.label{display:flex;flex-direction:column;line-height:1.05}
.label .zh{font-size:12px}
.label .en{font-size:11px;opacity:.9}
.paid .ring{stroke:var(--ok)}
.unpaid .ring{stroke:var(--bad)}

/* IG åœ–ç¤º */
.link-btn{display:inline-grid;place-items:center;width:28px;height:28px;border:none;background:transparent}
.link-btn img{width:24px;height:24px;border-radius:6px;display:block}

/* Toast & Modalï¼ˆæ—¢æœ‰ï¼‰ */
.toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#0f1117;border:1px solid #2b3244;color:#e5e7eb;padding:8px 12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.45);opacity:0;transition:opacity .25s;z-index:60}
.toast.show{opacity:1}
.backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}

/* â˜… Modal å…§å®¹å¯æ²å‹•ï¼Œé ‚éƒ¨/åº•éƒ¨å‡çµï¼ˆX èˆ‡ Closeï¼‰ */
.modal{
  width:min(560px,92vw);background:#0f1117;border-radius:16px;border:1px solid #2b3244;
  padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.5);position:relative;
  max-height:92vh; display:flex; flex-direction:column; overflow:auto;
}
.mhead{position:sticky; top:0; z-index:2; background:#0f1117; margin:-14px -14px 10px; padding:10px 14px 8px; border-bottom:1px solid #2b3244; border-top-left-radius:16px; border-top-right-radius:16px;}
.mfoot{position:sticky; bottom:0; z-index:2; background:#0f1117; margin:10px -14px -14px; padding:8px 14px 10px; border-top:1px solid #2b3244; border-bottom-left-radius:16px; border-bottom-right-radius:16px;}
.modal .title2{margin:0;font-size:18px;font-weight:800}
.modal .rb{height:2px;background:var(--rainbow);opacity:.5;border-radius:2px;margin-top:8px}
.modal .actions{display:flex;gap:10px;justify-content:flex-end}
.modal .actions .btn{
  border: none !important;
  background: rgba(0,255,209,.08) !important;
  box-shadow: 0 0 0 1px rgba(0,255,209,.25), 0 0 18px rgba(0,255,209,.18) inset, 0 0 20px rgba(0,255,209,.15) !important;
  color: #e5e7eb !important;
  font-weight: 800 !important;
  padding: 6px 9px !important;
  border-radius: 10px !important;
  cursor:pointer;
}
.modal .actions .btn:hover{
  background: rgba(0,255,209,.08) !important;
  box-shadow: 0 0 0 1px rgba(0,255,209,.35), 0 0 22px rgba(0,255,209,.22) inset, 0 0 24px rgba(0,255,209,.20) !important;
  border: 1px solid transparent !important;
  border-image: var(--rainbow) 1 !important;
}
.btn{padding:8px 10px;border-radius:12px;border:1px solid #2b3244;background:#0f1117;color:#e5e7eb;font-weight:800;cursor:pointer}

/* ä»˜æ¬¾å½ˆçª—å…§çš„å–®é¸é¸é … */
.payopts{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.opt{flex:1;min-width:160px;text-align:center;padding:10px;border-radius:12px;border:1px dashed #2b3244;cursor:pointer;background:#0f1117;color:#9aa4af;font-weight:900}
.opt.active{border:0;background:var(--btn-grad);color:#0b0c10}

/* æ¦‚è¦½ï¼ˆä¾ Leader åˆ†çµ„ï¼‰ */
.ov-section{margin-top:14px}
.leader-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.leader-card{background:#10131A;border:1px solid #2b3244;border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px;position:relative}
.leader-head{display:flex;align-items:center;justify-content:space-between}
.leader-left{display:flex;align-items:center;gap:8px;min-width:0}
.leader-name{
  font-weight:900;
  background: var(--rainbow);
  -webkit-background-clip:text; background-clip:text; color:transparent;
}
.leader-name.overview{
  background:none; -webkit-background-clip:unset; background-clip:unset; color:#C7CED6; /* ç¸½è¦½éŠ€è‰² */
}
.leader-meta{font-size:12px;color:#9AA4AF;display:flex;align-items:center;gap:8px}
.meta-icon{display:inline-grid;place-items:center}
.meta-icon svg{width:12px;height:12px;display:block}
/* âœ… æ‰“å‹¾/å‰å°ä¸€é» */
.leader-actions{display:flex;gap:8px}
.leader-toggle{padding:4px 8px;border-radius:9px;border:1px solid #2b3244;background:#0f1117;color:#e5e7eb;font-size:12px;cursor:pointer}
.leader-toggle:hover{border-image:var(--rainbow) 1;border-width:1px;border-style:solid}
.leader-list{display:flex;flex-direction:column;gap:6px}
.member-line{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.02);border:1px dashed #2b3244;border-radius:8px;padding:6px 8px;cursor:pointer}
.member-line:hover{background:rgba(255,255,255,.04)}
.mini{display:flex;align-items:center;gap:8px;min-width:0}
.mini .m-name{font-size:12px;max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mini .m-ig{font-size:11px;color:#9AA4AF;max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; text-transform:uppercase; } /* âœ… IG å¤§å¯« */

/* æ¦‚è¦½é¡¯ç¤º/éš±è—æ§åˆ¶ï¼šå…­è‰²å½©è™¹æŒ‰éˆ•ï¼ˆæ”¶åˆæ™‚æ‰å‡ºç¾ï¼‰ */
.ov-toggle{
  position:fixed;left:50%;bottom:12px;transform:translateX(-50%);
  display:none;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;
  background:#0f1117;border:1px solid #2b3244;cursor:pointer;z-index:40;
}
.ov-toggle .dot{
  width:12px;height:12px;border-radius:999px;background:conic-gradient(#EF4444,#F59E0B,#FACC15,#22C55E,#3B82F6,#8B5CF6,#EF4444);
  box-shadow:0 0 10px rgba(255,255,255,.08) inset, 0 2px 8px rgba(0,0,0,.35);
}
.ov-toggle:hover{border-image:var(--rainbow) 1;border-width:1px;border-style:solid}

/* å€‹åˆ¥éš±è—åˆ—ï¼ˆå…­è‰²å½©è™¹åœ“é»æ¢å¾©ï¼‰ */
#ovHiddenBar{display:none;margin-top:8px;padding:8px 10px;border-top:1px solid #2b3244;background:#0f1117;border-radius:12px}
#ovHiddenTop{display:flex;align-items:center;justify-content:space-between;gap:6px;flex-wrap:wrap;margin-bottom:6px}
#ovHiddenList{display:flex;flex-wrap:wrap;gap:12px;max-height:96px;overflow:auto;padding:2px 0 6px}
.hchip{display:flex;align-items:center;gap:8px}
.hchip .dot{width:14px;height:14px;border-radius:999px;box-shadow:0 0 0 1px #2b3244 inset, 0 2px 8px rgba(0,0,0,.35);cursor:pointer}
.hchip .label{font-size:11px;color:#9AA4AF;max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* ğŸ‘ éš±è—æŒ‰éˆ•ï¼šæ”¹ç‚ºè·Ÿåœ¨æ¡Œé•·åå­—å·¦é‚Šï¼Œå‚ç›´ç½®ä¸­ */
.leader-hide{
  position:static;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:24px;
  height:24px;
  border:none;
  background:transparent;
  color:#9AA4AF;
  cursor:pointer;
  font-size:16px;
  line-height:1;
  transition:filter .15s ease;
}
.leader-hide:hover{filter:drop-shadow(0 0 6px rgba(255,255,255,.15))}

/* â€”â€” æ§åˆ¶é¢æ¿å››é¡†æŒ‰éˆ•çš„æ’ç‰ˆï¼šæ°´å¹³æ’åˆ—ã€ä¿ç•™é–“è·ã€ä¸é€£åœ¨ä¸€èµ· â€”â€” */
.fabrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
.fab{ padding:10px 12px; border-radius:12px; border:1px solid(var(--border)); background:#0f1117; color:#e5e7eb; font-weight:800; cursor:pointer; }
.fab.primary{ background:var(--btn-grad); color:#0b0c10; border:0; }

/* Spinner */
.spinner{display:inline-block;width:14px;height:14px;margin-left:8px;vertical-align:-2px;border:2px solid rgba(255,255,255,.18);border-top-color:#a7f3d0;border-radius:50%;animation:spin .9s linear infinite;box-shadow:0 0 10px rgba(167,243,208,.35)}
@keyframes spin{to{transform:rotate(360deg)}}

@media (max-width:860px){
  .row{grid-template-columns:1fr}
  .fabrow{justify-content:flex-start}
}

/* ===== è¡¨æ ¼å…±ç”¨ï¼ˆå·²ç¹³è²»/æœªç¹³è²»æ¸…å–® & NOTEï¼‰ ===== */
.tablewrap{max-height:70vh;overflow:auto;border:1px solid #2b3244;border-radius:12px}
.table{width:100%;border-collapse:collapse;font-size:13px}
.table thead th{position:sticky;top:0;background:#0f1117;border-bottom:1px solid #2b3244;padding:8px 10px;text-align:left;color:#cbd5e1;white-space:nowrap}
.table tbody td{border-bottom:1px dashed #2b3244;padding:6px 8px;color:#e5e7eb;vertical-align:top}
.table .muted{color:#9AA4AF}
.table .status-paid{color:#86efac;font-weight:800}
.table .status-unpaid{color:#fca5a5;font-weight:800}
.table td.center{text-align:center}

/* ===== NOTE Modal ===== */
.note-filters{ display:flex;flex-direction:column;gap:6px;margin:8px 0;align-items:flex-start }
/* ç¬¬ä¸€è¡Œï¼šæœå°‹èˆ‡åªçœ‹æœªç¹³è²» + ä¸‰è§’åˆ‡æ› + Save */
.nf-row1{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.note-filters input[type="text"]{
  padding:4px 8px; border-radius:10px; border:1px solid #e5e7eb; background:#ffffff; color:#0b0c10;
  width:140px; /* çŸ­ä¸€é»çš„ bar */ max-width:42vw;
}
.note-filters label{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#9AA4AF;white-space:nowrap}
/* âœ… NOTE çš„ checkboxï¼šæ¡Œæ©Ÿ 10Ã—10ï¼Œç½®ä¸­å°é½Š */
.note-filters input[type="checkbox"]{width:10px;height:10px;vertical-align:middle}

.nf-tri{ border:1px solid #2b3244; background:#0f1117; color:#e5e7eb; padding:4px 8px; border-radius:8px; cursor:pointer; line-height:1; font-size:12px; }
.nf-tri[aria-expanded="true"]::after{ content:" â–¾"; }
.nf-tri[aria-expanded="false"]::after{ content:" â–¸"; }

/* Save æŒ‰éˆ•ï¼ˆé å³ï¼‰ */
.nf-save{ margin-left:auto; border:1px solid #2b3244; background:#0f1117; color:#e5e7eb; padding:4px 10px; border-radius:8px; cursor:pointer; font-weight:800; font-size:12px; }
.nf-save[disabled]{opacity:.6; cursor:not-allowed;}
.nf-save:hover{ border-image:var(--rainbow) 1; border-width:1px; border-style:solid; }

/* ç¬¬äºŒè¡Œï¼šé€²éšï¼ˆæ”¶åˆç”¨ï¼‰ */
.nf-adv{display:none; align-items:center; gap:10px; flex-wrap:wrap}
.nf-adv.show{display:flex;}
.note-tight{white-space:nowrap}
.note-checkbox{width:10px;height:10px;cursor:pointer} /* âœ… æ¡Œæ©Ÿ 10Ã—10 */
.note-select{background:#0f1117;border:1px solid #2b3244;color:#e5e7eb;border-radius:8px;padding:6px 8px;min-width:88px;max-width:140px}
.note-input{background:#0f1117;border:1px solid #2b3244;color:#e5e7eb;border-radius:8px;padding:6px 8px;width:100%}

/* æ¬„å¯¬å¾®èª¿ï¼šç¸®å°åˆ°èˆ‡ checkbox æ–‡æ¡ˆåŒç´š */
.wctrl{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#9AA4AF}
.wctrl .btncol{display:flex;flex-direction:column;gap:2px}
.wbtn{
  padding:2px 6px;border-radius:8px;border:1px solid #2b3244;background:#0f1117;color:#e5e7eb;
  font-size:11px;line-height:1;cursor:pointer;height:18px;
}

/* âœ… NOTE è¡¨æ ¼æ›´ç·Šæ¹Š */
.table-note{table-layout:fixed; width:100%}
.table-note th,.table-note td{ padding:4px 6px; }
.table-note th.note-tight,.table-note td.note-tight{
  padding:3px 6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* âœ… å¯èª¿æ¬„å¯¬ï¼ˆä»¥ CSS è®Šæ•¸é©…å‹•ï¼ŒJS æ–¼æ¸²æŸ“æ™‚è¨­å®šï¼‰ */
.table-note col.c-flag{width:40px}
.table-note col.c-name{width:var(--nameW,60px)}
.table-note col.c-ig{width:var(--igW,60px)}      /* é è¨­ 60pxï¼Œå¯èª¿ */
/* leader æ”¹ç‚ºå›ºå®šå¯¬ï¼ˆç§»é™¤èª¿æ•´åŠŸèƒ½ï¼‰ */
.table-note col.c-leader{width:80px}
.table-note col.c-status{width:64px}
/* è®“ã€Œç¢ºèªã€ã€Œæ–¹å¼ã€æ›´é ç·Šï¼šç¸®æ¬„å¯¬ï¼ˆâ¬… æ–°ï¼šæ–¹å¼æ›´è²¼è¿‘ç¢ºèªï¼‰ */
.table-note col.c-confirm{width:54px}
.table-note col.c-method{width:80px}  /* åŸ 96px -> 80px */
/* â¬‡ï¸ æ–°å¢ï¼šå‚™è¨»æ¬„å›ºå®šè¼ƒå¯¬ï¼Œé¿å…è¢«æ“ æ‰ï¼ˆæ¡Œæ©Ÿï¼‰ */
.table-note col.c-note{width:var(--noteW,240px)}

/* âœ… æ¬„ä½é¡¯ç¤º/éš±è—ï¼ˆå¥—åœ¨ table ä¸Šçš„ classï¼‰ */
.table-note.hide-flag col.c-flag,
.table-note.hide-flag thead th:nth-child(1),
.table-note.hide-flag tbody td:nth-child(1){display:none}
.table-note.hide-name col.c-name,
.table-note.hide-name thead th:nth-child(2),
.table-note.hide-name tbody td:nth-child(2){display:none}
.table-note.hide-ig col.c-ig,
.table-note.hide-ig thead th:nth-child(3),
.table-note.hide-ig tbody td:nth-child(3){display:none}
.table-note.hide-leader col.c-leader,
.table-note.hide-leader thead th:nth-child(4),
.table-note.hide-leader tbody td:nth-child(4){display:none}
.table-note.hide-status col.c-status,
.table-note.hide-status thead th:nth-child(5),
.table-note.hide-status tbody td:nth-child(5){display:none}

/* âœ… NOTE ç¹³è²»æ¬„ï¼šè¡¨é ­ï¼‹å…§æ–‡æ•´æ¬„ç½®ä¸­ */
.table-note thead th.status-head{ text-align:center; }
.table-note td.status-cell{font-size:12px;white-space:nowrap;text-align:center; vertical-align:middle;}
/* â¬… æ–°å¢ï¼šç¹³è²»æ¬„åœ–ç¤ºå‚ç›´ç½®ä¸­ä¿®æ­£ */
.table-note td.status-cell .meta-icon{ display:flex; align-items:center; justify-content:center; height:100%; }
.table-note td.status-cell svg{ display:block; }

/* âœ… NOTE ç¢ºèª/æ–¹å¼æ¬„ padding å†ç¸®ï¼ˆè²¼è¿‘ï¼‰ */
.table-note thead th:nth-child(6),
.table-note tbody td:nth-child(6),
.table-note thead th:nth-child(7),
.table-note tbody td:nth-child(7){ padding-left:3px; padding-right:3px; }

/* âœ… NOTEï¼šIG æ¬„ä½é¡¯ç¤ºå¤§å¯« */
.table-note tbody td:nth-child(3){ text-transform:uppercase; }

/* ğŸ“± æ‰‹æ©Ÿï¼šæŠŠ NOTE æ”¹æˆã€Œå…¨è¢å¹•é ã€ï¼‹ ç½®é ‚æœå°‹åˆ—ï¼Œä¸¦æŠŠ NOTE å‹¾é¸ç¸®å° */
@media (max-width:640px){
  #noteBackdrop{align-items:stretch; justify-content:stretch;}
  #noteBackdrop .modal{
    width:100vw; height:100vh; max-width:none; max-height:none; border-radius:0; border-left:none; border-right:none; padding:10px 10px 0; display:flex; flex-direction:column;
  }
  #noteBackdrop .note-filters{
    position:sticky; top:0; z-index:2; background:#0f1117; padding-top:6px; padding-bottom:8px; border-bottom:1px solid #2b3244;
  }
  #noteBackdrop .tablewrap{ flex:1; max-height:none; min-height:0; overflow:auto; }
  /* ç¬¬ä¸€è¡Œä¸‰é …å‰›å¥½æ’æ»¿ */
  .nf-row1{display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:8px;}
  .note-filters input[type="text"]{width:100%; max-width:100%;}
  .note-filters input[type="checkbox"]{width:8px;height:8px;} /* âœ… æ‰‹æ©Ÿç¸®å° */
  .note-checkbox{width:8px;height:8px;} /* âœ… æ‰‹æ©Ÿç¸®å° */

  /* â¬‡ï¸ é‡è¦ï¼šæ‰‹æ©Ÿæ™‚è®“ NOTE è¡¨å¯æ©«å‘æ²å‹•ä¸¦æ”¾å¤§å‚™è¨»æ¬„ï¼Œé¿å…è¢«æ“ æ‰ */
  #noteTableWrap{ overflow-x:auto; }
  .table-note{ min-width:820px; } /* ä¿è­‰å„æ¬„ä¸è‡³æ–¼æ“ çˆ† */
  .table-note col.c-name{width:var(--nameW,60px)}
  .table-note col.c-ig{width:var(--igW,60px)}
  .table-note col.c-leader{width:70px}
  .table-note col.c-confirm{width:54px}
  .table-note col.c-method{width:80px}
  .table-note col.c-note{ width:min(70vw, 420px); } /* ğŸ“Œ æ‰‹æ©Ÿæ”¾å¤§å‚™è¨»æ¬„ */
  .table-note th,.table-note td{ padding:4px 6px; }
  .note-input{ min-width:200px; } /* é˜²æ­¢è¼¸å…¥æ¡†è¢«å£“åˆ°çœ‹ä¸åˆ° */
}

/* âœ… éš±è— NOTE é€²éšæ¬„ä½çš„åƒç´ è®€æ•¸ï¼ˆä»å¯èª¿æ•´ï¼‰ */
#wNameV,#wIgV{display:none;}

/* ====== æ¸…å–®ï¼ˆPaid/Unpaidï¼‰æ¬„å¯¬å¯èª¿ï¼ˆæ»‘æ¡¿ï¼‰ ====== */
.table-list{table-layout:fixed; width:100%}
/* æ›´ç·Šæ¹Šï¼šæ¸…å–®è¡¨æ ¼å­—å°ã€å…§è·å°ï¼Œèƒ½é¡¯ç¤ºæ›´å¤šç­† */
.table-list{font-size:12px}
.table-list thead th{padding:6px 8px}
.table-list tbody td{padding:4px 6px}
.table-list col.c-time{width:96px}
.table-list col.c-name{width:var(--listNameW,120px)}
.table-list col.c-ig{width:var(--listIgW,120px)}
.table-list col.c-leader{width:var(--listLeaderW,90px)}
.table-list col.c-status{width:70px}

/* æ¸…å–®æ»‘æ¡¿æ§åˆ¶å€ï¼ˆç·Šæ¹Š & å¯æ”¶åˆï¼‰ */
#listTopBar{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px;}
#listCtrls{display:flex; flex-direction:column; gap:4px; margin:4px 0 8px;}
.wrow{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
.wrow label{font-size:11px; color:#9AA4AF; width:auto;}
.wrow input[type="range"]{flex:1; min-width:120px;}
.wrow .val{font-size:11px; color:#9AA4AF; width:44px; text-align:right;}
#listToggleCtrl{font-size:12px; padding:4px 8px; border-radius:8px; border:1px solid #2b3244; background:#0f1117; color:#e5e7eb; cursor:pointer;}

/* NOTE æ¨™é¡Œæ—ç¸½æ•¸æ¨£å¼ */
.note-ok{ color:var(--ok); font-weight:900; margin-left:6px; }

/* å½ˆçª—çµ±ä¸€ã€Œå³ä¸Šè§’å‰å‰ã€æ¨£å¼ï¼ˆç½®ä¸­é¡¯ç¤ºï¼Œç„¡æ¡†ã€è—è‰²ç™¼å…‰ï¼‰ */
.modal-close, .note-close{
  position:sticky; top:8px; margin-left:auto; display:grid; place-items:center;
  width:28px; height:28px; border:none; border-radius:0; background:transparent;
  color:#3B82F6;
  text-shadow: 0 0 8px rgba(59,130,246,.8), 0 0 14px rgba(59,130,246,.5);
  cursor:pointer; line-height:1; font-size:20px; font-weight:900;
}
.modal-close:hover, .note-close:hover{ filter:brightness(1.1); border:none; }
</style>
</head>
<body>
<div class="wrap">
  <!-- æ¨™é¡Œ -->
  <div class="tl">
    <div class="t1">Taiwan Pride ğŸŒˆ</div>
    <div class="t2">Reservation Payment</div>
    <div class="t3">10/24 é€±äº”æ™šé¤åå–®</div>
  </div>
  <div class="rainbow-line"></div>

  <!-- çµ±è¨ˆï¼ˆé ‚éƒ¨ä¿ç•™åŸæ¨£ + NOTEï¼‰ -->
  <div id="stats" class="stats">
    <div class="chip total"><span class="dot"></span><span class="lab">ç¸½è¨ˆ / Total</span><b class="num" id="sTotal">0</b></div>
    <div class="chip paid"><span class="dot"></span><span class="lab">å·²ç¹³è²» / Paid</span><b class="num" id="sPaid">0</b></div>
    <div class="chip unpaid"><span class="dot"></span><span class="lab">æœªç¹³è²» / Unpaid</span><b class="num" id="sUnpaid">0</b></div>
    <!-- NOTE åŠŸèƒ½ï¼šæ–°å¢ä¸€é¡† chip -->
    <div class="chip note" id="chipNote" title="è¨»è¨˜ / Note"><span class="dot"></span><span class="lab">Note</span></div>
  </div>

  <!-- æ§åˆ¶é¢æ¿ -->
  <div class="card">
    <div class="row">
      <div class="input-wrap">
        <label>å§“å / NAME</label>
        <input id="nameInput" list="nameList" placeholder="è¼¸å…¥æˆ–é¸æ“‡å§“å / Type or choose a name"/>
        <datalist id="nameList"></datalist>
      </div>
      <div class="input-wrap">
        <label>IG å¸³è™Ÿ / IG</label>
        <input id="igInput" list="igList" placeholder="è¼¸å…¥æˆ–é¸æ“‡ IG / Type or choose IG"/>
        <datalist id="igList"></datalist>
      </div>
      <div class="input-wrap">
        <button id="btnSearch" class="primary">æ‰‹å‹•æŸ¥æ‰¾ / Manual Search</button>
      </div>
    </div>

    <div class="fabrow">
      <button id="btnScan" class="fab primary">æƒæ QR / Scan QR</button>
      <button id="btnRefresh" class="fab">é‡æ–°æ•´ç† / Refresh</button>
      <button id="btnDiagnose" class="fab" style="display:none" disabled>è¨ºæ–· / Diagnose</button>
      <!-- âœ… æš«æ™‚ä¸é¡¯ç¤ºã€ä¸é‹ä½œ -->
    </div>
  </div>

  <!-- æŸ¥æ‰¾çµæœæŠ¬é ­ -->
  <div id="head" class="card" style="padding:10px">
    <span id="headMsg">è³‡æ–™è¼‰å…¥ä¸­â€¦ / Loading rosterâ€¦</span><span class="spinner" aria-hidden="true"></span>
  </div>

  <div id="grid" class="grid"></div>

  <!-- æ¦‚è¦½ï¼ˆLeader åˆ†çµ„ï¼›å¯æ•´æ®µæ”¶åˆï¼›å€‹åˆ¥éš±è—ï¼‰ -->
  <div id="ovSection" class="ov-section">
    <div class="leader-head" style="margin-bottom:6px">
      <div class="leader-name overview">ç¸½è¦½ / Overview</div>
      <div class="leader-meta" id="ovHint">By Leader</div>
      <button id="btnOvHide" class="leader-toggle" title="éš±è—ç¸½è¦½">éš±è— / Hide</button>
    </div>
    <div id="leaderGrid" class="leader-grid"></div>

    <div id="ovHiddenBar">
      <div id="ovHiddenTop">
        <div class="leader-meta">å·²éš±è—ï¼š<b id="ovHiddenCount">0</b></div>
        <button id="ovUnhideAll" class="leader-toggle">å–æ¶ˆå…¨éƒ¨éš±è—</button>
      </div>
      <div id="ovHiddenList"></div>
    </div>
  </div>
</div>

<!-- æ”¶åˆæ™‚é¡¯ç¤ºçš„å…­è‰²å½©è™¹é–‹é—œ -->
<button id="btnOvShow" class="ov-toggle" title="é¡¯ç¤ºç¸½è¦½ / Show Overview">
  <span class="dot" aria-hidden="true"></span><span>ç¸½è¦½ Overview</span>
</button>

<!-- ä»˜æ¬¾å½ˆçª— -->
<div id="payBackdrop" class="backdrop">
  <div class="modal">
    <div class="mhead">
      <button class="modal-close" id="payCloseX" aria-label="Close">Ã—</button>
      <div class="title2">ä»˜æ¬¾ç‹€æ…‹ / Payment Status</div>
      <div class="rb"></div>
    </div>

    <div id="payInfo"></div>
    <!-- å–®é¸ + é€å‡º -->
    <div class="payopts">
      <div id="optUnpaid" class="opt" data-val="unpaid">æœªä»˜æ¬¾ / Unpaid</div>
      <div id="optPaid" class="opt" data-val="paid">å·²ä»˜æ¬¾ / Paid</div>
    </div>

    <div class="mfoot">
      <div class="actions">
        <button id="paySubmit" class="btn">é€å‡º / Submit</button>
        <button id="payClose" class="btn">é—œé–‰ / Close</button>
      </div>
    </div>
  </div>
</div>

<!-- âœ… å·²ç¹³è²»/æœªç¹³è²»æ¸…å–® Modal -->
<div id="listBackdrop" class="backdrop">
  <div class="modal" style="width:min(760px,94vw)">
    <div class="mhead">
      <button class="modal-close" id="listCloseX" aria-label="Close">Ã—</button>
      <div id="listTopBar">
        <div id="listTitle" class="title2">æ¸…å–®</div>
        <button id="listToggleCtrl" title="é¡¯ç¤º/æ”¶èµ·æ¬„å¯¬èª¿æ•´">æ¬„å¯¬</button>
      </div>
      <div class="rb"></div>

      <!-- â¬‡ æ›´ç·Šæ¹Šçš„ä¸‰æ¢æ»‘æ¡¿ï¼Œå¯æ”¶åˆ -->
      <div id="listCtrls">
        <div class="wrow">
          <label for="lNameRange">name</label>
          <input id="lNameRange" type="range" min="40" max="240" step="10">
          <span id="lNameV" class="val">120px</span>
        </div>
        <div class="wrow">
          <label for="lIgRange">ig</label>
          <input id="lIgRange" type="range" min="40" max="240" step="10">
          <span id="lIgV" class="val">120px</span>
        </div>
        <div class="wrow">
          <label for="lLeaderRange">leader</label>
          <input id="lLeaderRange" type="range" min="40" max="240" step="10">
          <span id="lLeaderV" class="val">90px</span>
        </div>
      </div>
    </div>

    <div id="listBody" class="tablewrap"></div>

    <div class="mfoot">
      <div class="actions">
        <button id="listClose" class="btn">é—œé–‰ / Close</button>
      </div>
    </div>
  </div>
</div>

<!-- âœ… NOTE Modalï¼ˆéœ€å¯†ç¢¼ï¼‰ -->
<div id="noteBackdrop" class="backdrop">
  <div class="modal" style="width:min(980px,96vw); position:relative">
    <div class="mhead">
      <button class="note-close" id="noteCloseX" aria-label="Close">Ã—</button>
      <div class="title2">è¨»è¨˜ / Note <span id="noteCount" class="note-ok"></span></div>
      <div class="rb"></div>

      <!-- ç¯©é¸/æœå°‹åˆ—ï¼ˆæ–°ç‰ˆæ’ç‰ˆï¼‰ -->
      <div class="note-filters">
        <!-- ç¬¬ä¸€è¡Œï¼šæœå°‹/æœªç¹³è²»/å±•é–‹/å„²å­˜ï¼ˆSave ç½®å³ï¼‰ -->
        <div class="nf-row1">
          <input type="text" id="noteSearchName" placeholder="æœå°‹ name">
          <input type="text" id="noteSearchIg" placeholder="æœå°‹ ig">
          <label class="nf-check"><input type="checkbox" id="noteOnlyUnpaid"> åªçœ‹æœªç¹³è²»</label>
          <button id="noteToggle" class="nf-tri" aria-expanded="false" title="æ›´å¤šè¨­å®š"></button>
          <button id="noteSave" class="nf-save" title="å„²å­˜ Note">Save</button>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šå±•é–‹æ‰é¡¯ç¤ºï¼ˆåƒ…ä¿ç•™ name/ig æ¬„å¯¬èª¿æ•´ï¼›ç§»é™¤ leader èª¿æ•´ï¼‰ -->
        <div id="noteAdv" class="nf-adv" aria-hidden="true">
          <div class="wctrl">
            <span class="note-tight">nameå¯¬</span>
            <div class="btncol">
              <button id="wNameUp" class="wbtn" title="å¢åŠ  name æ¬„å¯¬">â–²</button>
              <button id="wNameDown" class="wbtn" title="æ¸›å°‘ name æ¬„å¯¬">â–¼</button>
            </div>
            <span id="wNameV" class="note-tight">60px</span>
          </div>
          <div class="wctrl">
            <span class="note-tight">igå¯¬</span>
            <div class="btncol">
              <button id="wIgUp" class="wbtn" title="å¢åŠ  ig æ¬„å¯¬">â–²</button>
              <button id="wIgDown" class="wbtn" title="æ¸›å°‘ ig æ¬„å¯¬">â–¼</button>
            </div>
            <span id="wIgV" class="note-tight">60px</span>
          </div>

          <!-- æ¬„ä½é¡¯ç¤ºï¼ˆåªç•™é—œéµå­—ï¼‰ -->
          <label><input type="checkbox" id="showFlag" checked> flag</label>
          <label><input type="checkbox" id="showName" checked> name</label>
          <label><input type="checkbox" id="showIg" checked> ig</label>
          <label><input type="checkbox" id="showLeader"> leader</label>
          <label><input type="checkbox" id="showStatus" checked> ç¹³è²»ç‹€æ…‹</label>
        </div>
      </div>
    </div>

    <div id="noteTableWrap" class="tablewrap"></div>

    <div class="mfoot">
      <div class="actions">
        <button id="noteClose" class="btn">é—œé–‰ / Close</button>
      </div>
    </div>
  </div>
</div>

<!-- éš±è—çš„æª”æ¡ˆ input ä¾›ã€ŒQR åœ–ç‰‡å‚™æ´ã€ -->
<input id="qrFile" type="file" accept="image/*" style="display:none" />

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
/* ===== (1) è¨­å®šï¼šæ›æˆä½ çš„ GAS URL ===== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwtoGYXhk6qd0XuTOUvB6YZNNzdjXoGQEl7298-Pbtc-G-qNuoLM2kTknZZOQO9qZ_Y1A/exec';
const PAY_PASSWORD = '05140714';
/* âœ… æ˜¯å¦å•Ÿç”¨é€å‡ºæ™‚å¯†ç¢¼é©—è­‰ï¼ˆæš«æ™‚é—œé–‰å°±è¨­ falseï¼›è¦å†é–‹å•Ÿæ”¹ trueï¼‰ */
const ENABLE_PAY_PASSWORD = false;
/* âœ… NOTE å¯†ç¢¼æ”¹ç‚ºç¨ç«‹å¸¸æ•¸ï¼ˆé è¨­ 0327ï¼‰ */
const NOTE_PASSWORD = '0327';

/* ===== (2) ç‹€æ…‹ ===== */
const state = {
  rows: [],          // é›²ç«¯ roster
  indexByItem: new Map(),
  selected: null,    // ä»˜æ¬¾å½ˆçª—é¸ä¸­çš„äºº
  chosenPay: null,   // 'paid' / 'unpaid'
  ovHidden: false,   // æ¦‚è¦½æ˜¯å¦æ”¶åˆ
  /* NOTE åŠŸèƒ½ï¼ˆé è¨­æ¬„å¯¬ï¼‰ */
  nameW: 60,
  igW: 60,
  /* æ¸…å–®ï¼ˆPaid/Unpaidï¼‰æ¬„å¯¬ï¼ˆæ»‘æ¡¿ä¸‰é …ï¼‰ */
  listNameW: 120,
  listIgW: 120,
  listLeaderW: 90,
  noteAuthed: false
};
const hiddenLeaders = new Set();
const RAINBOW = ['#EF4444','#F59E0B','#FACC15','#22C55E','#3B82F6','#8B5CF6'];

/* ===== (3) å°å·¥å…· ===== */
const $ = (id)=>document.getElementById(id);
const norm = (s)=> (s||'').toString().trim().toLowerCase();
const showToast = (msg)=>{
  const t = $('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 1600);
};
const headMsg = (html, spinning=false)=>{
  $('head').innerHTML = '';
  const span = document.createElement('span');
  span.id='headMsg'; span.innerHTML = html;
  $('head').appendChild(span);
  if(spinning){
    const sp=document.createElement('span'); sp.className='spinner';
    $('head').appendChild(sp);
  }
};
/* å°åœ–ç¤ºï¼ˆå‹¾/å‰ï¼‰ */
const SVG_CHECK = '<span class="meta-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10.5" fill="#0f1117" stroke="#22c55e" stroke-width="2.6"/><path d="M7 12.5l3 3 6-6" stroke="#fff" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span>';
const SVG_CROSS = '<span class="meta-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10.5" fill="#0f1117" stroke="#ef4444" stroke-width="2.6"/><path d="M8 8l8 8M16 8l-8 8" stroke="#fff" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span>';

/* ===== (4) è®€å–é›²ç«¯ï¼ˆé€²é å°±è¼‰ & æ¸²æŸ“ç¸½è¦½ï¼‰ ===== */
async function fetchRoster(){
  try{
    headMsg('è³‡æ–™è¼‰å…¥ä¸­â€¦ / Loading rosterâ€¦', true);
    const res = await fetch(WEB_APP_URL + '?mode=roster', {cache:'no-store'});
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.rows || []);
    rows.forEach(r=>{
      if(!('pay_status' in r) || !r.pay_status) r.pay_status = 'unpaid';
      // ç¢ºä¿ NOTE æ¬„ä½å­˜åœ¨ï¼ˆä¸ç ´å£æ—¢æœ‰ï¼‰
      if(!('confirm' in r)) r.confirm = false;
      if(!('pay_method' in r)) r.pay_method = '';
      if(!('note' in r)) r.note = '';
    });
    state.rows = rows;
    state.indexByItem.clear();
    for(const r of rows){ if(r.item) state.indexByItem.set(String(r.item), r); }

    rebuildDatalists();
    renderStats();
    headMsg('', false);
    renderOverview();
  }catch(err){
    console.error(err);
    headMsg('åå–®è¼‰å…¥å¤±æ•—ï¼ˆå¯èƒ½ä¸æ˜¯ JSON æˆ– CORSï¼‰/ Failed to load roster', false);
  }
}
function rebuildDatalists(){
  const dlN = $('nameList'); const dlI = $('igList');
  dlN.innerHTML=''; dlI.innerHTML='';
  const names = [...new Set(state.rows.map(r=>r.name).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  const igs = [...new Set(state.rows.map(r=>r.ig).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  names.forEach(v=>{ const o=document.createElement('option'); o.value=v; dlN.appendChild(o); });
  igs.forEach(v=>{ const o=document.createElement('option'); o.value=v; dlI.appendChild(o); });
}

/* ===== (5) çµ±è¨ˆ ===== */
function renderStats(){
  const total = state.rows.length;
  const paid = state.rows.filter(r=> norm(r.pay_status)==='paid').length;
  const unpaid = total - paid;
  $('sTotal').textContent = total;
  $('sPaid').textContent = paid;
  $('sUnpaid').textContent= unpaid;
}

/* ===== (6) æœå°‹ï¼ˆæ‰‹å‹•ï¼‰â†’ ä»˜æ¬¾å½ˆçª— ===== */
$('btnSearch').addEventListener('click', manualSearch);
$('nameInput').addEventListener('keydown', e=>{ if(e.key==='Enter') manualSearch(); });
$('igInput').addEventListener('keydown', e=>{ if(e.key==='Enter') manualSearch(); });

function manualSearch(){
  if(!state.rows.length){ showToast('åå–®æœªå°±ç·’ / Roster not ready'); return; }
  const qn = norm($('nameInput').value);
  const qi = norm($('igInput').value);

  if(qi){
    const row = state.rows.find(r=> norm(r.ig)===qi);
    if(row) { openPayModal(row); return; }
  }
  if(qn){
    const row = state.rows.find(r=> norm(r.name)===qn);
    if(row) { openPayModal(row); return; }
  }
  const cand = state.rows.filter(r => (qi && norm(r.ig||'').includes(qi)) || (qn && norm(r.name||'').includes(qn)) );
  if(cand.length===1){ openPayModal(cand[0]); return; }
  renderOnlyMatches(cand);
}

function renderOnlyMatches(rows){
  const grid = $('grid'); grid.innerHTML = '';
  if(!rows || !rows.length){ headMsg('æŸ¥ç„¡è³‡æ–™ / No results', false); return; }
  headMsg(`ç¬¦åˆ ${rows.length} ç­† / matched records`, false);
  rows.slice().sort((a,b)=> (a.country||'').localeCompare(b.country||'') || (a.name||'').localeCompare(b.name||''))
    .forEach(r=> grid.appendChild(renderPerson(r)));
}

function renderPerson(r){
  const card = document.createElement('div');
  card.className='person';
  card.dataset.item = String(r.item||''); // â˜… åŠ å…¥ data-item ä¾›è£œä¸æ›´æ–°
  card.addEventListener('click', ()=> openPayModal(r)); // é»å¡ç‰‡é–‹å½ˆçª—

  // ç¬¬ä¸€è¡Œ
  const L1 = document.createElement('div'); L1.className='line';
  const left1 = document.createElement('div'); left1.className='left namebar';
  const flag = document.createElement('div'); flag.className='flag'; flag.textContent = r.flag || 'â€”';
  const ctry = document.createElement('span'); ctry.className='country'; ctry.textContent = r.country || 'â€”';
  const name = document.createElement('span'); name.className='personN goldtext'; name.textContent = r.name || 'â€”';
  const ig = document.createElement('span'); ig.className='ig goldtext'; ig.textContent = r.ig || 'â€”';
  left1.append(flag, ctry, name, ig);
  L1.append(left1);

  // ç¬¬äºŒè¡Œï¼špay_status + link
  const L2 = document.createElement('div'); L2.className='line';
  const left2 = document.createElement('div'); left2.className='left paybox iconsonly';
  left2.append(buildPay(r.pay_status, true));
  const right2 = document.createElement('div'); right2.className='right';
  if(r.link){
    const a = document.createElement('a'); a.href = r.link; a.target='_blank'; a.rel='noopener noreferrer'; a.className='link-btn';
    const img = document.createElement('img'); img.src='pngsucai_1605688_ec16ce.png'; img.alt='Open link';
    a.appendChild(img); right2.appendChild(a);
  }
  L2.append(left2, right2);

  card.append(L1,L2);
  return card;
}

function buildPay(status, iconsOnly=false){
  const s = norm(status)==='paid' ? 'paid' : 'unpaid';
  const box = document.createElement('div'); box.className='pay';
  const badge = document.createElement('div'); badge.className='badge '+s;
  badge.innerHTML = s==='paid'
    ? '<svg viewBox="0 0 24 24"><circle class="ring" cx="12" cy="12" r="10.5"/><path class="glyph" d="M7 12.5l3 3 6-6"/></svg>'
    : '<svg viewBox="0 0 24 24"><circle class="ring" cx="12" cy="12" r="10.5"/><path class="glyph" d="M8 8l8 8M16 8l-8 8"/></svg>';
  const circle = badge.querySelector('circle');
  if(circle){
    if(s==='paid') circle.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--ok')||'#22c55e');
    if(s==='unpaid') circle.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--bad')||'#ef4444');
  }
  box.append(badge);
  if(!iconsOnly){
    const lab = document.createElement('div'); lab.className='label';
    lab.innerHTML = s==='paid' ? '<span class="zh">å·²ç¹³è²»</span><span class="en">Paid</span>' : '<span class="zh">æœªç¹³è²»</span><span class="en">Unpaid</span>';
    box.append(lab);
  }
  return box;
}

/* ===== (7) ä»˜æ¬¾å½ˆçª— ===== */
const payBackdrop = $('payBackdrop');
const paySubmit = $('paySubmit');
$('payClose').addEventListener('click', ()=> { payBackdrop.style.display='none'; state.chosenPay=null; setOptActive(null); });
$('payCloseX').addEventListener('click', ()=> { payBackdrop.style.display='none'; state.chosenPay=null; setOptActive(null); }); /* å³ä¸Šè§’å‰å‰ */
$('optPaid').addEventListener('click', ()=> setOptActive('paid'));
$('optUnpaid').addEventListener('click', ()=> setOptActive('unpaid'));

function setOptActive(val){
  state.chosenPay = val;
  document.querySelectorAll('.opt').forEach(o=>o.classList.remove('active'));
  if(val==='paid') $('optPaid').classList.add('active');
  if(val==='unpaid') $('optUnpaid').classList.add('active');
}

function openPayModal(person){
  state.selected = person;
  setOptActive(null);
  const gold = (s)=> `<b class="goldtext">${escapeHtml(s||'â€”')}</b>`;
  const html = `
    <div>åœ‹æ—— / Flagï¼š<b>${escapeHtml(person.flag||'â€”')}</b></div>
    <div>å§“å / Nameï¼š${gold(person.name)}</div>
    <div>IGï¼š${gold(person.ig)}</div>
    <div>ç›®å‰ç‹€æ…‹ / Currentï¼š<b>${norm(person.pay_status)==='paid'?'å·²ç¹³è²» / Paid':'æœªç¹³è²» / Unpaid'}</b></div>
  `;
  $('payInfo').innerHTML = html;
  payBackdrop.style.display='flex';
}
function escapeHtml(s){
  return (s||'').toString().replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
}

/* ===== é€å‡ºä»˜æ¬¾æ›´æ–° ===== */
paySubmit.addEventListener('click', async ()=>{
  if(!state.selected){ payBackdrop.style.display='none'; return; }
  if(!state.chosenPay){ showToast('è«‹é¸æ“‡ã€Œå·²ä»˜æ¬¾æˆ–æœªä»˜æ¬¾ã€'); return; }
  if (ENABLE_PAY_PASSWORD) {
    const p = prompt('è«‹è¼¸å…¥ä»˜æ¬¾æ›´æ–°å¯†ç¢¼ / Enter password');
    if(p === null) return;
    if(p !== PAY_PASSWORD){ showToast('å¯†ç¢¼éŒ¯èª¤ / Wrong password'); return; }
  }
  const prevHtml = paySubmit.innerHTML;
  paySubmit.disabled = true;
  paySubmit.innerHTML = 'é€å‡ºä¸­â€¦ <span class="spinner" aria-hidden="true"></span>';
  try{
    await updatePay(state.chosenPay);
  }catch(e){
    console.error(e);
    showToast('æ›´æ–°å¤±æ•— / Update failed');
  }finally{
    paySubmit.disabled = false;
    paySubmit.innerHTML = prevHtml;
    state.chosenPay = null; setOptActive(null);
    payBackdrop.style.display = 'none';
  }
});

/* â˜…â˜…â˜…â˜…â˜… åªè£œä¸æ›´æ–°ï¼Œä¸é‡ç¹ªæ•´é ï¼ˆå¤§å¹…é™ä½å»¶é²ï¼‰ â˜…â˜…â˜…â˜…â˜… */
function patchPayDom(item, val){
  const safe = String(item||'');
  document.querySelectorAll(`.person[data-item="${CSS.escape(safe)}"] .paybox`).forEach(el=>{
    const iconsOnly = el.classList.contains('iconsonly');
    el.innerHTML = ''; el.appendChild(buildPay(val, iconsOnly));
  });
  document.querySelectorAll(`.member-line[data-item="${CSS.escape(safe)}"] .paybox`).forEach(el=>{
    el.innerHTML = ''; el.appendChild(buildPay(val, /*iconsOnly*/ false));
  });
}

async function updatePay(val){
  const person = state.selected;
  try{
    const payload = { action:'updatePayStatus', item:String(person.item||''), pay_status:val };
    const ok = await postMaybeOk(payload);
    if(!ok) throw new Error('SERVER_NOK');
    person.pay_status = val;
    const local = state.indexByItem.get(String(person.item||'')); if(local) local.pay_status = val;
    renderStats(); patchPayDom(person.item, val);
    showToast('å·²æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ / Payment updated');
  }catch(e){
    console.error(e); showToast('æ›´æ–°å¤±æ•— / Update failed');
  }
}

/* èƒ½å®¹å¿å¤šç¨®å¾Œç«¯ Content-Type / CORS ç­–ç•¥ */
async function postMaybeOk(bodyObj){
  if(await tryFetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(bodyObj), mode:'cors', cache:'no-store' })) return true;
  if(await tryFetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(bodyObj), mode:'cors', cache:'no-store' })) return true;
  const form = new URLSearchParams(); Object.entries(bodyObj).forEach(([k,v])=> form.append(k,String(v)));
  if(await tryFetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form.toString(), mode:'no-cors', cache:'no-store' })) return true;
  return false;
}
async function tryFetch(url, init){
  try{
    const res = await fetch(url, init);
    if(res.type==='opaque') return true;
    if(res.ok) return true;
    try{ const j = await res.json(); return !!(j && (j.ok || Array.isArray(j))); }catch(_){}
    return false;
  }catch(_){ return false; }
}

/* ===== (8) æ¦‚è¦½ ===== */
$('btnOvHide').addEventListener('click', ()=>{ state.ovHidden=true; syncOvToggle(); });
$('btnOvShow').addEventListener('click', ()=>{ state.ovHidden=false; syncOvToggle(); });

function syncOvToggle(){
  $('ovSection').style.display = state.ovHidden ? 'none' : '';
  $('btnOvShow').style.display = state.ovHidden ? 'flex' : 'none';
}

function renderOverview(){
  syncOvToggle();
  const grid = $('leaderGrid'); grid.innerHTML='';
  if(!state.rows.length){ grid.innerHTML = '<div class="leader-meta">å°šæœªè¼‰å…¥åå–® / Not loaded</div>'; return; }

  const groups = new Map();
  for(const r of state.rows){
    const key = (r.leader||'â€”').trim();
    if(!groups.has(key)) groups.set(key, []);
    groups.get(key).push(r);
  }

  for(const [leader, members] of groups){
    if(hiddenLeaders.has(leader)) continue;
    const paid = members.filter(m=> norm(m.pay_status)==='paid').length;
    const unpaid = members.length - paid;

    const card = document.createElement('div'); card.className='leader-card';
    const head = document.createElement('div'); head.className='leader-head';

    const left = document.createElement('div'); left.className='leader-left';
    const hideBtn = document.createElement('button'); hideBtn.className='leader-hide'; hideBtn.title='éš±è—æ­¤æ¡Œé•· / Hide this leader'; hideBtn.textContent='ğŸ‘';
    hideBtn.addEventListener('click', ()=>{ hiddenLeaders.add(leader); renderOverview(); renderHiddenBar(); });

    const title = document.createElement('div'); title.className='leader-name'; title.textContent = leader || 'â€”';
    left.append(hideBtn, title);

    const meta = document.createElement('div'); meta.className='leader-meta';
    meta.innerHTML = `${members.length} äºº Â· ${SVG_CHECK}${paid} Â· ${SVG_CROSS}${unpaid}`;

    head.append(left, meta);

    const actions = document.createElement('div'); actions.className='leader-actions';
    const btnToggle = document.createElement('button'); btnToggle.className='leader-toggle'; btnToggle.textContent='æŸ¥çœ‹æ¸…å–® / View';
    actions.append(btnToggle);

    const list = document.createElement('div'); list.className='leader-list'; list.style.display='none';
    members.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||'')).forEach(m=>{
      const line = document.createElement('div'); line.className='member-line'; line.dataset.item = String(m.item||'');
      line.title = 'é»æ“Šä¿®æ”¹ä»˜æ¬¾ç‹€æ…‹ / Click to change payment'; line.addEventListener('click', ()=> openPayModal(m));
      const leftM = document.createElement('div'); leftM.className='mini';
      const flag = document.createElement('div'); flag.textContent = m.flag || 'â€”';
      const nm = document.createElement('div'); nm.className='m-name goldtext'; nm.textContent = m.name || 'â€”';
      const ig = document.createElement('div'); ig.className='m-ig goldtext'; ig.textContent = m.ig || '';
      leftM.append(flag,nm,ig);
      const rightM = document.createElement('div'); rightM.style.display='flex'; rightM.style.gap='8px'; rightM.className = 'paybox';
      rightM.append(buildPay(m.pay_status, false));
      line.append(leftM,rightM);
      list.appendChild(line);
    });
    btnToggle.addEventListener('click', ()=>{ list.style.display = (list.style.display==='none') ? '' : 'none'; });

    card.append(head, actions, list);
    grid.appendChild(card);
  }
}
function renderHiddenBar(){
  const bar = $('ovHiddenBar'), list = $('ovHiddenList'), cnt = $('ovHiddenCount');
  if(!bar) return;
  const items = [...hiddenLeaders];
  if(cnt) cnt.textContent = String(items.length);
  if(items.length===0){ bar.style.display='none'; if(list) list.innerHTML=''; return; }
  bar.style.display='block';
  if(list){
    list.innerHTML=''; let i=0;
    for(const leader of items){
      const chip = document.createElement('div'); chip.className='hchip';
      const dot = document.createElement('div'); dot.className='dot'; dot.style.background = RAINBOW[i % RAINBOW.length];
      dot.title='é»æ“Šæ¢å¾© ' + leader;
      dot.addEventListener('click', ()=>{ hiddenLeaders.delete(leader); renderOverview(); renderHiddenBar(); });
      const lab = document.createElement('div'); lab.className='label'; lab.textContent = leader;
      chip.append(dot, lab); list.appendChild(chip); i++;
    }
  }
}
$('ovUnhideAll')?.addEventListener('click', ()=>{ hiddenLeaders.clear(); renderOverview(); renderHiddenBar(); });

/* ===== (9) æƒæ QR ===== */
$('btnScan').addEventListener('click', startScan);
async function startScan(){
  const supported = ('BarcodeDetector' in window);
  if(supported){
    try{
      const detector = new window.BarcodeDetector({ formats:['qr_code'] });
      const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }});
      const video = document.createElement('video'); video.playsInline = true; video.srcObject = stream; await video.play();
      const tick = async ()=>{
        if(video.readyState >= 2){
          const bitmap = await createImageBitmap(video);
          const codes = await detector.detect(bitmap);
          bitmap.close();
          if(codes && codes.length){
            await stopStream(stream);
            const item = (codes[0].rawValue||'').trim();
            handleScanItem(item); return;
          }
        }
        requestAnimationFrame(tick);
      };
      tick();
      showToast('æƒæä¸­â€¦ å°‡ QR å°æº–é¡é ­ / Scanningâ€¦'); return;
    }catch(e){ console.warn('BarcodeDetector video path failed, fallback to file', e); }
  }
  const input = $('qrFile');
  input.onchange = async (e)=>{
    const f = (e.target.files||[])[0];
    if(!f){ showToast('æœªé¸å–åœ–ç‰‡ / No image selected'); return; }
    try{
      if(!('BarcodeDetector' in window)) throw new Error('no-detector');
      const detector = new window.BarcodeDetector({ formats:['qr_code'] });
      const bmp = await createImageBitmap(f);
      const codes = await detector.detect(bmp);
      bmp.close();
      if(codes && codes.length){ handleScanItem((codes[0].rawValue||'').trim()); }
      else{ showToast('è§£æå¤±æ•—ï¼Œè«‹æ”¹ç”¨æ‰‹å‹•æŸ¥æ‰¾ / Parse failed, use manual search'); }
    }catch(err){
      console.warn(err); showToast('è£ç½®ä¸æ”¯æ´ QR è§£æï¼›è«‹æ”¹ç”¨æ‰‹å‹•æŸ¥æ‰¾ / Not supported, use manual search');
    } finally { input.value=''; }
  };
  input.click();
}
async function stopStream(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch(_){ } }
function handleScanItem(itemStr){
  if(!itemStr){ showToast('QR ç„¡å…§å®¹ / Empty QR'); return; }
  const row = state.indexByItem.get(String(itemStr));
  if(!row){ showToast('æŸ¥ç„¡æ­¤ ITEM Â· è«‹ç¢ºèª / Item not found'); return; }
  openPayModal(row);
}

/* ===== (10) é‡æ–°æ•´ç† & æ•…éšœè¨ºæ–· ===== */
$('btnRefresh').addEventListener('click', ()=> fetchRoster()); // è¨ºæ–·æŒ‰éˆ•æš«ä¸é‹ä½œï¼ˆå·²æ–¼ HTML éš±è—ä¸¦ disabledï¼‰

/* ===== (11) å·²ç¹³è²»/æœªç¹³è²»æ¸…å–® ===== */
const listBackdrop = $('listBackdrop');
const listBody = $('listBody');
const listTitle = $('listTitle');
$('listClose').addEventListener('click', ()=> listBackdrop.style.display='none');
$('listCloseX').addEventListener('click', ()=> listBackdrop.style.display='none'); /* å³ä¸Šè§’å‰å‰ */
listBackdrop.addEventListener('click', (e)=>{ if(e.target===listBackdrop) listBackdrop.style.display='none'; });

document.addEventListener('click', (e)=>{
  const paidChip = e.target.closest?.('.chip.paid');
  const unpaidChip = e.target.closest?.('.chip.unpaid');
  const noteChip = e.target.closest?.('#chipNote');
  if(paidChip){ openListModal('paid'); }
  if(unpaidChip){ openListModal('unpaid'); }
  if(noteChip){ openNoteModal(); } // NOTE åŠŸèƒ½å…¥å£
});

$('listToggleCtrl').addEventListener('click', ()=>{
  const ctrls = $('listCtrls');
  if(!ctrls) return;
  const show = ctrls.style.display !== 'none';
  ctrls.style.display = show ? 'none' : 'flex';
});

function openListModal(kind){
  if(!state.rows.length){ showToast('åå–®æœªå°±ç·’ / Roster not ready'); return; }
  if(kind==='paid'){
    const rows = state.rows.filter(r=> norm(r.pay_status)==='paid')
      .sort((a,b)=> getTimeValue(b) - getTimeValue(a));
    listTitle.textContent = `å·²ç¹³è²»ç´€éŒ„ / Paid Recordsï¼ˆ${rows.length}ï¼‰`;
    listBody.innerHTML = buildPaidTable(rows);
  }else{
    const rows = state.rows.filter(r=> norm(r.pay_status)!=='paid')
      .sort((a,b)=> (a.leader||'').localeCompare(b.leader||'') || (a.name||'').localeCompare(b.name||''));
    listTitle.textContent = `æœªç¹³è²»åå–® / Unpaid Listï¼ˆ${rows.length}ï¼‰`;
    listBody.innerHTML = buildUnpaidTable(rows);
  }
  applyListWidths(); 
  initListSliders();        /* â¬… æ–°å¢ï¼šé–‹çª—å¾Œåˆå§‹åŒ–æ»‘æ¡¿ */
  listBackdrop.style.display='flex';
}
// æ™‚é–“æŠ“å–
function getTimeValue(r){
  const cand = r.updatedAt || r.updated_at || r.updatePayStatus || r.updated || r.time || '';
  const t = Date.parse(cand);
  if(!isNaN(t)) return t;
  const n = Number(cand);
  if(!isNaN(n) && n>10_000_000_000) return n; // ms
  if(!isNaN(n) && n>0) return n*1000; // sec
  return 0;
}
function fmtTime(ts){
  if(!ts) return 'â€”';
  const d = new Date(ts);
  if(isNaN(d.getTime())) return 'â€”';
  try{
    /* âœ… æ™‚é–“é¡¯ç¤ºç°¡åŒ–ç‚ºï¼š10/21 19:33 */
    return d.toLocaleString('zh-TW', { timeZone:'Asia/Taipei', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
  }catch(_){
    return d.toISOString().replace('T',' ').slice(5,16);
  }
}
function safe(s){ return escapeHtml(s??''); }

function buildPaidTable(rows){
  const colgroup = `<colgroup>
    <col class="c-time"><col class="c-name"><col class="c-ig"><col class="c-leader"><col class="c-status">
  </colgroup>`;
  const th = `<thead><tr>
    <th>æ™‚é–“</th><th>name</th><th>ig</th><th>leader</th><th>ç¹³è²»ç‹€æ…‹</th>
  </tr></thead>`;
  const tb = rows.map(r=>{
    const t = fmtTime(getTimeValue(r));
    const stat = '<span class="status-paid">å·²ç¹³è²»</span>';
    return `<tr>
      <td class="muted">${safe(t)}</td>
      <td>${safe(r.name)}</td>
      <td class="muted" style="text-transform:uppercase">${safe(r.ig)}</td>
      <td class="muted">${safe(r.leader)}</td>
      <td class="center">${stat}</td>
    </tr>`;
  }).join('');
  return `<div class="tablewrap"><table class="table table-list" id="paidTable">${colgroup}${th}<tbody>${tb||'<tr><td colspan="5">ç„¡è³‡æ–™</td></tr>'}</tbody></table></div>`;
}
function buildUnpaidTable(rows){
  const colgroup = `<colgroup>
    <col class="c-name"><col class="c-ig"><col class="c-leader"><col class="c-status">
  </colgroup>`;
  const th = `<thead><tr>
    <th>name</th><th>ig</th><th>leader</th><th>ç¹³è²»ç‹€æ…‹</th>
  </tr></thead>`;
  const tb = rows.map(r=>{
    const stat = '<span class="status-unpaid">æœªç¹³è²»</span>';
    return `<tr>
      <td>${safe(r.name)}</td>
      <td class="muted" style="text-transform:uppercase">${safe(r.ig)}</td>
      <td class="muted">${safe(r.leader)}</td>
      <td class="center">${stat}</td>
    </tr>`;
  }).join('');
  return `<div class="tablewrap"><table class="table table-list" id="unpaidTable">${colgroup}${th}<tbody>${tb||'<tr><td colspan="4">ç„¡è³‡æ–™</td></tr>'}</tbody></table></div>`;
}

/* æ¸…å–®æ¬„å¯¬å¥—ç”¨ï¼ˆæ»‘æ¡¿ï¼‰ */
function applyListWidths(){
  document.querySelectorAll('.table-list').forEach(t=>{
    t.style.setProperty('--listNameW', state.listNameW+'px');
    t.style.setProperty('--listIgW', state.listIgW+'px');
    t.style.setProperty('--listLeaderW', state.listLeaderW+'px');
  });
  const nV = $('lNameV'); if(nV) nV.textContent = state.listNameW+'px';
  const iV = $('lIgV');   if(iV) iV.textContent   = state.listIgW+'px';
  const lV = $('lLeaderV'); if(lV) lV.textContent = state.listLeaderW+'px';
}

/* åˆå§‹åŒ–æ»‘æ¡¿èˆ‡äº‹ä»¶ï¼ˆæ¯æ¬¡é–‹æ¸…å–®è¦–çª—åŸ·è¡Œï¼‰ */
function initListSliders(){
  const rN = $('lNameRange'), rI = $('lIgRange'), rL = $('lLeaderRange');
  if(rN){ rN.value = state.listNameW; rN.oninput = (e)=>{ state.listNameW = +e.target.value; applyListWidths(); }; }
  if(rI){ rI.value = state.listIgW;   rI.oninput = (e)=>{ state.listIgW   = +e.target.value; applyListWidths(); }; }
  if(rL){ rL.value = state.listLeaderW; rL.oninput = (e)=>{ state.listLeaderW = +e.target.value; applyListWidths(); }; }
}

/* ===== (12) NOTE åŠŸèƒ½ ===== */
const noteBackdrop = $('noteBackdrop');
const noteTableWrap = $('noteTableWrap');
$('noteClose').addEventListener('click', ()=> noteBackdrop.style.display='none');
$('noteCloseX').addEventListener('click', ()=> noteBackdrop.style.display='none'); /* å³ä¸Šè§’å‰å‰ */
noteBackdrop.addEventListener('click', (e)=>{ if(e.target===noteBackdrop) noteBackdrop.style.display='none'; });

$('noteOnlyUnpaid').addEventListener('change', ()=>{ renderNoteTable(); });
$('noteSearchName').addEventListener('input', ()=>{ renderNoteTable(); });
$('noteSearchIg').addEventListener('input', ()=>{ renderNoteTable(); });

/* ä»ä¿ç•™åŸæœ¬ç›£è½ï¼ˆä¸å­˜åœ¨å°±ç•¥éï¼‰ï¼Œå†åŠ ä¸Šæ–°æŒ‰éˆ•ç›£è½ */
['wName','wIg','showFlag','showName','showIg','showLeader','showStatus'].forEach(id=>{
  $(id)?.addEventListener('input', renderNoteTable);
  $(id)?.addEventListener('change', renderNoteTable);
});

/* æ–°å¢ï¼šä¸Šä¸‹æŒ‰éˆ•æ§åˆ¶æ¬„å¯¬ï¼ˆ30~200ï¼Œæ­¥é€²10ï¼‰ */
function adjustWidth(kind, delta){
  const min=30, max=200, step=10;
  if(kind==='name'){ state.nameW = Math.max(min, Math.min(max, state.nameW + (delta>0?step:-step))); }
  else if(kind==='ig'){ state.igW = Math.max(min, Math.min(max, state.igW + (delta>0?step:-step))); }
  renderNoteTable();
}
$('wNameUp')?.addEventListener('click', ()=>adjustWidth('name', +1));
$('wNameDown')?.addEventListener('click', ()=>adjustWidth('name', -1));
$('wIgUp')?.addEventListener('click', ()=>adjustWidth('ig', +1));
$('wIgDown')?.addEventListener('click', ()=>adjustWidth('ig', -1));

/* æ–°å¢ï¼šä¸‰è§’å½¢å±•é–‹/æ”¶åˆé€²éšé¸å–® */
const noteToggleBtn = $('noteToggle');
const noteAdv = $('noteAdv');
noteToggleBtn?.addEventListener('click', ()=>{
  const expanded = noteToggleBtn.getAttribute('aria-expanded') === 'true';
  noteToggleBtn.setAttribute('aria-expanded', String(!expanded));
  noteAdv.classList.toggle('show', !expanded);
  noteAdv.setAttribute('aria-hidden', String(expanded));
});

/* NOTE é–‹å•Ÿ */
function openNoteModal(){
  if(!state.noteAuthed){
    const p = prompt('è«‹è¼¸å…¥ Note å¯†ç¢¼');
    if(p===null) return;
    if(p!==NOTE_PASSWORD){ showToast('å¯†ç¢¼éŒ¯èª¤ / Wrong password'); return; }
    state.noteAuthed = true;
  }
  renderNoteTable();
  noteBackdrop.style.display='flex';
}

/* NOTE æ¨™é¡Œä¸Šçš„ç¢ºèªå‹¾å‹¾ç¸½æ•¸ */
function updateNoteConfirmCount(){
  const el = $('noteCount');
  if(!el) return;
  const tbody = noteTableWrap.querySelector('tbody');
  let count = 0;
  if(tbody){
    count = tbody.querySelectorAll('input.note-checkbox:checked').length;
  }else{
    count = state.rows.filter(r=>!!r.confirm).length;
  }
  el.textContent = `(${count})`;
}

/* NOTE è¡¨æ ¼æ¸²æŸ“ï¼ˆæ”¹ç‚ºï¼šåªæ¸²æŸ“ï¼Œä¸è‡ªå‹•å„²å­˜ï¼‰ */
function renderNoteTable(){
  if(!state.rows.length){
    noteTableWrap.innerHTML = '<div class="leader-meta">å°šæœªè¼‰å…¥åå–® / Not loaded</div>';
    updateNoteConfirmCount();
    return;
  }
  const onlyUnpaid = $('noteOnlyUnpaid').checked;
  const qn = norm($('noteSearchName').value);
  const qi = norm($('noteSearchIg').value);

  let rows = state.rows.slice();
  if(onlyUnpaid) rows = rows.filter(r=> norm(r.pay_status)!=='paid');
  if(qn) rows = rows.filter(r=> norm(r.name||'').includes(qn));
  if(qi) rows = rows.filter(r=> norm(r.ig||'').includes(qi));

  // æ’åºï¼šleader -> name
  rows.sort((a,b)=> (a.leader||'').localeCompare(b.leader||'') || (a.name||'').localeCompare(b.name||''));

  // è®€å– UI è¨­å®šï¼ˆæ¬„å¯¬ & é¡¯ç¤ºï¼‰
  const nameW = Number($('wName')?.value || state.nameW || 60);
  const igW = Number($('wIg')?.value || state.igW || 60);
  $('wNameV').textContent = nameW + 'px';
  $('wIgV').textContent = igW + 'px';

  const showFlag = $('showFlag')?.checked !== false;
  const showName = $('showName')?.checked !== false;
  const showIg = $('showIg')?.checked !== false;
  const showLeader = $('showLeader')?.checked !== false;
  const showStatus = $('showStatus')?.checked !== false;

  const colgroup = `<colgroup>
    <col class="c-flag"><col class="c-name"><col class="c-ig"><col class="c-leader">
    <col class="c-status"><col class="c-confirm"><col class="c-method"><col class="c-note">
  </colgroup>`;

  const th = `<thead><tr>
    <th class="note-tight">flag</th>
    <th class="note-tight">name</th>
    <th class="note-tight">ig</th>
    <th class="note-tight">leader</th>
    <th class="note-tight status-head">ç¹³è²»</th>
    <th class="note-tight">ç¢ºèª</th>
    <th class="note-tight">æ–¹å¼</th>
    <th class="note-tight">å‚™è¨»</th>
  </tr></thead>`;

  const body = rows.map(r=>{
    const item = String(r.item||'');
    const isPaid = norm(r.pay_status)==='paid';
    const checked = r.confirm ? 'checked' : '';
    const method = r.pay_method || '';
    const note = r.note || '';
    return `<tr data-item="${escapeHtml(item)}">
      <td class="note-tight">${safe(r.flag||'')}</td>
      <td class="note-tight">${safe(r.name||'')}</td>
      <td class="note-tight" style="text-transform:uppercase">${safe(r.ig||'')}</td>
      <td class="note-tight">${safe(r.leader||'')}</td>
      <td class="status-cell">${isPaid ? SVG_CHECK : SVG_CROSS}</td>
      <td><input type="checkbox" class="note-checkbox" ${checked}></td>
      <td>
        <select class="note-select">
          <option value=""></option>
          <option value="éŠ€è¡Œ" ${method==='éŠ€è¡Œ'?'selected':''}>éŠ€è¡Œ</option>
          <option value="LinePay" ${method==='LinePay'?'selected':''}>LinePay</option>
          <option value="é›»å­æ”¯ä»˜" ${method==='é›»å­æ”¯ä»˜'?'selected':''}>é›»å­æ”¯ä»˜</option>
          <option value="ç¾é‡‘" ${method==='ç¾é‡‘'?'selected':''}>ç¾é‡‘</option>
        </select>
      </td>
      <td><input type="text" class="note-input" value="${escapeHtml(note)}" placeholder="è¼¸å…¥å‚™è¨»"></td>
    </tr>`;
  }).join('');

  const tableHtml = `<table class="table table-note" style="--nameW:${nameW}px;--igW:${igW}px">${colgroup}${th}<tbody>${body||'<tr><td colspan="8">ç„¡è³‡æ–™</td></tr>'}</tbody></table>`;
  noteTableWrap.innerHTML = tableHtml;

  const tableEl = noteTableWrap.querySelector('.table-note');
  tableEl.classList.toggle('hide-flag', !showFlag);
  tableEl.classList.toggle('hide-name', !showName);
  tableEl.classList.toggle('hide-ig', !showIg);
  tableEl.classList.toggle('hide-leader', !showLeader);
  tableEl.classList.toggle('hide-status', !showStatus);

  updateNoteConfirmCount();
}

/* ===== NOTE å„²å­˜ï¼ˆå…ˆè©¦æ‰¹æ¬¡ï¼Œå¤±æ•—å†é€ç­†ï¼‰ ===== */
$('noteSave').addEventListener('click', saveNotes);

async function saveNotes(){
  const btn = $('noteSave');
  const tbody = noteTableWrap.querySelector('tbody');
  if(!tbody){ showToast('ç„¡å¯å„²å­˜è³‡æ–™'); return; }
  const prevHtml = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = 'Saving <span class="spinner" aria-hidden="true"></span>';

  const rows = Array.from(tbody.querySelectorAll('tr[data-item]'));
  const payloads = [];
  for(const tr of rows){
    const item = tr.getAttribute('data-item');
    const confirmEl = tr.querySelector('.note-checkbox');
    const selectEl = tr.querySelector('.note-select');
    const inputEl = tr.querySelector('.note-input');
    const confirmVal = !!(confirmEl && confirmEl.checked);
    const methodVal = selectEl ? selectEl.value : '';
    const noteVal = inputEl ? inputEl.value : '';

    const row = state.indexByItem.get(String(item));
    if(!row) continue;
    const changed = (row.confirm !== confirmVal) || (row.pay_method !== methodVal) || (row.note !== noteVal);
    if(changed){
      payloads.push({ item, confirm:confirmVal, pay_method:methodVal, note:noteVal });
    }
  }

  if(!payloads.length){
    btn.disabled = false; btn.innerHTML = prevHtml;
    showToast('æ²’æœ‰è®Šæ›´');
    updateNoteConfirmCount();
    return;
  }

  // â‘  å˜—è©¦ã€Œå–®æ¬¡æ‰¹æ¬¡ã€é€å‡ºï¼ˆå¾Œç«¯è‹¥æ”¯æ´æœƒæ›´å¿«ï¼‰
  let okCount = 0, bulkTried = false, bulkOK = false;
  try{
    bulkTried = true;
    const bulk = { action:'updateNotes', items: payloads }; // ä»¥ item ç‚ºå”¯ä¸€éµ
    bulkOK = await postMaybeOk(bulk);
    if(bulkOK){
      okCount = payloads.length;
      for(const p of payloads){
        const row = state.indexByItem.get(String(p.item));
        if(row){ row.confirm = p.confirm; row.pay_method = p.pay_method; row.note = p.note; }
      }
    }
  }catch(_){ /* å¿½ç•¥ï¼Œèµ° fallback */ }

  // â‘¡ è‹¥æ‰¹æ¬¡ä¸æ”¯æ´ï¼Œfallbackï¼šé€ç­†å¹³è¡Œ
  if(!bulkOK){
    const tasks = payloads.map(p => postMaybeOk({ action:'updateNote', ...p }));
    const results = await Promise.allSettled(tasks);
    results.forEach((r,i)=>{
      if(r.status==='fulfilled' && r.value){
        okCount++;
        const p = payloads[i];
        const row = state.indexByItem.get(String(p.item));
        if(row){ row.confirm = p.confirm; row.pay_method = p.pay_method; row.note = p.note; }
      }
    });
  }

  btn.disabled = false; btn.innerHTML = prevHtml;
  showToast(okCount===payloads.length ? 'å·²å„²å­˜è¨»è¨˜ / Note saved' : `éƒ¨åˆ†å„²å­˜å¤±æ•—ï¼ˆæˆåŠŸ ${okCount}/${payloads.length}ï¼‰`);
  updateNoteConfirmCount();
}

/* ===== å•Ÿå‹• & éŒ¯èª¤æ””æˆª ===== */
window.addEventListener('error', (e)=>{ try{ console.error('[GlobalError]', e.message, e.filename, e.lineno, e.colno, e.error); }catch(_){}
  try{ showToast('ç™¼ç”ŸéŒ¯èª¤ï¼š' + (e.message || 'Script error')); }catch(_){} });
window.addEventListener('unhandledrejection', (e)=>{ try{ console.error('[UnhandledRejection]', e.reason); }catch(_){}
  try{ showToast('ç™¼ç”ŸéŒ¯èª¤ï¼ˆPromiseï¼‰ï¼š' + (e.reason && e.reason.message ? e.reason.message : '')); }catch(_){} });

/* ===== List/Note èƒŒæ™¯é»æ“Šæ”¶åˆ ===== */
listBackdrop.addEventListener('click', (e)=>{ if(e.target===listBackdrop) listBackdrop.style.display='none'; });

fetchRoster();
</script>
</body>
</html>
